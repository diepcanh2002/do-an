<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√¥ng Tin C√° Nh√¢n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    .card-custom {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
    }

    .bold-label {
      font-weight: bold;
    }
  </style>
</head>

<body>

  <nav class="navbar navbar-expand-lg bg-light shadow">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold text-dark" href="/">
        <i class="bi bi-house-door"></i> Trang ch·ªß
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-dark ms-3" href="/matches">
              <i class="bi bi-trophy"></i> Tr·∫≠n ƒë·∫•u
            </a>
          </li>
        </ul>

        <ul class="navbar-nav me-5">
          <li class="nav-item dropdown" th:if="${isAuthenticated}">
            <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle"></i> <span th:text="${username}">T√†i kho·∫£n</span>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/user/field-booking"><i class="bi bi-calendar"></i> Qu·∫£n
                  l√Ω l·ªãch ƒë·∫∑t</a></li>
              <li><a class="dropdown-item" href="/user/profile"><i class="bi bi-receipt"></i> Th√¥ng tin c√°
                  nh√¢n</a></li>
              <li><a class="dropdown-item" href="/user/notification"><i class="bi bi-bell"></i> Th√¥ng
                  b√°o</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right"></i> ƒêƒÉng
                  xu·∫•t</a></li>
            </ul>
          </li>

          <li class="nav-item dropdown" th:if="${!isAuthenticated}">
            <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle"></i> Ch∆∞a ƒëƒÉng nh·∫≠p
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/login"><i class="bi bi-box-arrow-in-right"></i> ƒêƒÉng
                  nh·∫≠p</a></li>
            </ul>
          </li>
        </ul>

      </div>
    </div>
  </nav>

  <nav aria-label="breadcrumb" class="mt-3 ms-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">üè† Trang ch·ªß</a></li>
      <li class="breadcrumb-item active" aria-current="page"> Th√¥ng tin c√° nh√¢n</li>
    </ol>
  </nav>

  <div class="container mt-4">
    <div class="card-custom">
      <h4 class="mb-3">üë§ Th√¥ng Tin C√° Nh√¢n</h4>
      <form id="infoForm">
        <div class="mb-3">
          <label class="form-label">H·ªç T√™n</label>
          <input type="text" class="form-control" id="fullName">
        </div>
        <div class="mb-3">
          <label class="form-label">S·ªë ƒêi·ªán Tho·∫°i</label>
          <input type="text" class="form-control" id="phoneNumber">
        </div>

        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="changePassword">
          <label class="form-check-label" for="changePassword">ƒê·ªïi M·∫≠t Kh·∫©u</label>
        </div>

        <div id="passwordForm" class="d-none">
          <div class="mb-3">
            <label class="form-label">M·∫≠t Kh·∫©u C≈©</label>
            <input type="password" class="form-control" id="oldPassword">
          </div>
          <div class="mb-3">
            <label class="form-label">M·∫≠t Kh·∫©u M·ªõi</label>
            <input type="password" class="form-control" id="newPassword">
          </div>
          <div class="mb-3">
            <label class="form-label">X√°c Nh·∫≠n M·∫≠t Kh·∫©u M·ªõi</label>
            <input type="password" class="form-control" id="confirmPassword">
          </div>
        </div>

        <button class="btn btn-primary" id="saveInfo">L∆∞u</button>
      </form>
    </div>
  </div>

  <script>


    var userId = localStorage.getItem("userId");

    $(document).ready(function () {
      getProfile(userId)
      // Khi checkbox "ƒê·ªïi M·∫≠t Kh·∫©u" ƒë∆∞·ª£c ch·ªçn
      $('#changePassword').change(function () {
        if ($(this).is(':checked')) {
          $('#passwordForm').removeClass('d-none');
          $('.form-label').addClass('fw-bold');
        } else {
          $('#passwordForm').addClass('d-none');
          $('.form-label').removeClass('fw-bold');
        }
      });

      // Khi nh·∫•n n√∫t "L∆∞u"
      $('#saveInfo').click(function (event) {
        event.preventDefault(); // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh

        let fullName = $('#fullName').val().trim();
        let phoneNumber = $('#phoneNumber').val().trim();
        let changePasswordChecked = $('#changePassword').is(':checked');
        let oldPassword = $('#oldPassword').val().trim();
        let newPassword = $('#newPassword').val().trim();
        let confirmPassword = $('#confirmPassword').val().trim();

        // Ki·ªÉm tra d·ªØ li·ªáu ƒë·∫ßu v√†o
        if (!fullName) {
          Swal.fire("L·ªói", "Vui l√≤ng nh·∫≠p h·ªç t√™n.", "error");
          return;
        }

        if (!phoneNumber || !/^\d{10}$/.test(phoneNumber)) {
          Swal.fire("L·ªói", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p 10 ch·ªØ s·ªë.", "error");
          return;
        }

        let formData = new FormData();
        formData.append("userId", userId);
        formData.append("fullName", fullName);
        formData.append("phone", phoneNumber);

        // N·∫øu ch·ªçn ƒë·ªïi m·∫≠t kh·∫©u
        if (changePasswordChecked) {
          if (!oldPassword || !newPassword || !confirmPassword) {
            Swal.fire("L·ªói", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin m·∫≠t kh·∫©u.", "error");
            return;
          }
          if (newPassword !== confirmPassword) {
            Swal.fire("L·ªói", "M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n m·∫≠t kh·∫©u kh√¥ng tr√πng kh·ªõp.", "error");
            return;
          }
          formData.append("oldPassword", oldPassword);
          formData.append("newPassword", newPassword);
        }

        // G·ª≠i d·ªØ li·ªáu qua AJAX
        $.ajax({
          url: "/api/user/update",
          type: "POST",  // ho·∫∑c "PUT" n·∫øu c·∫ßn
          processData: false, // Kh√¥ng x·ª≠ l√Ω d·ªØ li·ªáu
          contentType: false, // FormData t·ª± x·ª≠ l√Ω
          data: formData,
          success: function (response) {
            if (response.status === 1000) {
              Swal.fire({
                title: "L∆∞u th√¥ng tin th√†nh c√¥ng!",
                icon: "success"
              });
            } else {
              Swal.fire("L·ªói", response.message, "error");
            }
          },
          error: function (xhr, status, error) {
            console.error("L·ªói API:", error);
            Swal.fire("L·ªói", "ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t th√¥ng tin.", "error");
          }
        });

      });
    });

    function getProfile(id) {
      $.ajax({
        url: `/api/user/get-profile?userId=${id}`, // Thay URL_API_CUA_BAN b·∫±ng API th·ª±c t·∫ø
        type: 'GET', // Ho·∫∑c 'POST' n·∫øu API y√™u c·∫ßu
        dataType: 'json',
        success: function (response) {
          if (response.status === 1000) {
            let fullName = $('#fullName').val(response.data.full_name);
            let phoneNumber = $('#phoneNumber').val(response.data.phone)
          } else {
            console.log('L·ªói:', response.message);
          }
        },
        error: function (xhr, status, error) {
          console.log('C√≥ l·ªói x·∫£y ra:', error);
        }
      });

    }
  </script>
</body>

</html>