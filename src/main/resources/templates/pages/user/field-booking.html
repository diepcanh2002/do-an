<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.w3.org/1999/xhtml">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n L√Ω L·ªãch ƒê·∫∑t S√¢n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>


  <!-- Th√™m th∆∞ vi·ªán t·ª´ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background-color: #f8f9fa;
    }

    .booking-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 15px;
      text-align: left;
    }

    .status-success {
      color: green;
      font-weight: bold;
    }

    .status-pending {
      color: orange;
      font-weight: bold;
    }

    .status-cancelled {
      color: red;
      font-weight: bold;
    }

    .filter-box {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      max-width: 50%;
    }

    @media (max-width: 768px) {
      .filter-box {
        max-width: 100%;
      }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-light shadow">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold text-dark" href="#">
        <i class="bi bi-house-door"></i> Trang ch·ªß
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-dark ms-3" href="/matches">
              <i class="bi bi-trophy"></i> Tr·∫≠n ƒë·∫•u
            </a>
          </li>
        </ul>

        <ul class="navbar-nav me-5">
          <li class="nav-item dropdown" th:if="${isAuthenticated}">
            <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown">
              <i class="bi bi-person-circle"></i> <span th:text="${username}">T√†i kho·∫£n</span>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/user/field-booking"><i class="bi bi-calendar"></i> Qu·∫£n l√Ω l·ªãch
                  ƒë·∫∑t</a></li>
              <li><a class="dropdown-item" href="/user/profile"><i class="bi bi-receipt"></i> Th√¥ng tin c√° nh√¢n</a></li>
              <li><a class="dropdown-item" href="/user/notification"><i class="bi bi-bell"></i> Th√¥ng b√°o</a></li>
              <hr class="dropdown-divider">
          </li>
          <li><a class="dropdown-item text-danger" href="/logout"><i class="bi bi-box-arrow-right"></i> ƒêƒÉng
              xu·∫•t</a></li>
        </ul>
        </li>

        <li class="nav-item dropdown" th:if="${!isAuthenticated}">
          <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle"></i> Ch∆∞a ƒëƒÉng nh·∫≠p
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/login"><i class="bi bi-box-arrow-in-right"></i> ƒêƒÉng
                nh·∫≠p</a></li>
          </ul>
        </li>
        </ul>

      </div>
    </div>
  </nav>

  <nav aria-label="breadcrumb" class="mt-3 ms-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">üè† Trang ch·ªß</a></li>
      <li class="breadcrumb-item active" aria-current="page">üìÖ Qu·∫£n l√Ω l·ªãch ƒë·∫∑t</li>
    </ol>
  </nav>

  <div class="container mt-4">
    <h4 class="mb-3">üìÖ L·ªãch ƒë·∫∑t s√¢n </h4>

    <div class="filter-box d-flex flex-wrap align-items-center gap-2">
      L·ªãch ƒë·∫∑t s√¢n t·ª´ <input type="datetime-local" class="form-control" id="startDate" placeholder="Ng√†y b·∫Øt ƒë·∫ßu"
        style="width: 200px;">
      ƒë·∫øn <input type="datetime-local" class="form-control" id="endDate" placeholder="Ng√†y k·∫øt th√∫c"
        style="width: 200px;">
    </div>

    <div class="row row-cols-1 row-cols-md-4 g-3 mt-3" id="schedule-list">
      <!-- <div class="col">
        <div class="booking-card p-3">
          <h5 class="fw-bold">M√£: #12345</h5>
          <p><strong>T√™n s√¢n:</strong> S√¢n A</p>
          <p><strong>ƒê·ªãa ch·ªâ:</strong> 123 ƒê∆∞·ªùng ABC, TP.HCM</p>
          <p><strong>Ng√†y:</strong> 2025-03-26</p>
          <p><strong>Gi·ªù b·∫Øt ƒë·∫ßu:</strong> 18:00</p>
          <p><strong>Gi·ªù k·∫øt th√∫c:</strong> 20:00</p>
          <p class="status-success">‚úî ƒê√£ x√°c nh·∫≠n</p>
          <button class="btn btn-primary btn-sm">Xem h√≥a ƒë∆°n</button>
          <button class="btn btn-danger btn-sm">H·ªßy</button>
        </div>
      </div>
      <div class="col">
        <div class="booking-card p-3">
          <h5 class="fw-bold">M√£: #12346</h5>
          <p><strong>T√™n s√¢n:</strong> S√¢n B</p>
          <p><strong>ƒê·ªãa ch·ªâ:</strong> 456 ƒê∆∞·ªùng XYZ, TP.HCM</p>
          <p><strong>Ng√†y:</strong> 2025-03-27</p>
          <p><strong>Gi·ªù b·∫Øt ƒë·∫ßu:</strong> 16:00</p>
          <p><strong>Gi·ªù k·∫øt th√∫c:</strong> 18:00</p>
          <p class="status-pending">‚è≥ Ch·ªù x√°c nh·∫≠n</p>
          <button class="btn btn-primary btn-sm">Xem h√≥a ƒë∆°n</button>
          <button class="btn btn-danger btn-sm">H·ªßy</button>
        </div>
      </div>
      <div class="col">
        <div class="booking-card p-3">
          <h5 class="fw-bold">M√£: #12347</h5>
          <p><strong>T√™n s√¢n:</strong> S√¢n C</p>
          <p><strong>ƒê·ªãa ch·ªâ:</strong> 789 ƒê∆∞·ªùng LMN, TP.HCM</p>
          <p><strong>Ng√†y:</strong> 2025-03-28</p>
          <p><strong>Gi·ªù b·∫Øt ƒë·∫ßu:</strong> 19:00</p>
          <p><strong>Gi·ªù k·∫øt th√∫c:</strong> 21:00</p>
          <p class="status-cancelled">‚ùå ƒê√£ h·ªßy</p>
          <button class="btn btn-primary btn-sm">Xem h√≥a ƒë∆°n</button>
          <button class="btn btn-danger btn-sm" disabled>H·ªßy</button>
        </div>
      </div>
    </div> -->


    </div>
</body>
<script>
  let userId = localStorage.getItem("userId")
  $(document).ready(function () {
    const now = new Date();
    const sevenDaysLater = new Date();
    sevenDaysLater.setDate(now.getDate() + 7);

    // ƒê·ªãnh d·∫°ng ng√†y gi·ªù th√†nh chu·ªói ISO 8601 nh∆∞ng lo·∫°i b·ªè ph·∫ßn gi√¢y v√† k√Ω t·ª± "Z"
    const formatDateTime = (date) => date.toISOString().slice(0, 16);

    // G√°n gi√° tr·ªã m·∫∑c ƒë·ªãnh cho input
    $('#startDate').val(formatDateTime(now));
    $('#endDate').val(formatDateTime(sevenDaysLater));

    // G·ªçi loadData l·∫ßn ƒë·∫ßu v·ªõi gi√° tr·ªã m·∫∑c ƒë·ªãnh
    loadData($('#startDate').val(), $('#endDate').val(), userId);

    // Th√™m s·ª± ki·ªán khi thay ƒë·ªïi gi√° tr·ªã input
    $('#startDate, #endDate').on('change', function () {
      const startTime = $('#startDate').val();
      const endTime = $('#endDate').val();

      loadData(startTime, endTime, userId);
    });
  });



  function loadData(startTime, endTime, userId) {
    $.ajax({
      url: `/api/booking/get-booking-by-range-and-user-id?startTime=${startTime}&endTime=${endTime}&userId=${userId}`,
      method: 'GET',
      dataType: 'json',
      success: function (response) {
        if (response.status === 1000 && response.data) {
          const scheduleList = $('#schedule-list');
          scheduleList.empty();

          response.data.forEach(item => {
            let statusClass = '';
            let statusText = '';
            let disableInvoice = '';
            let disableCancel = '';

            switch (item.status) {
              case 'CONFIRMED':
                statusClass = 'status-success';
                statusText = '‚úî ƒê√£ x√°c nh·∫≠n';
                disableCancel = 'disabled';
                break;
              case 'PENDING':
                statusClass = 'status-pending';
                statusText = '‚è≥ Ch·ªù x√°c nh·∫≠n';
                disableInvoice = 'disabled';
                break;
              case 'CANCELED':
                statusClass = 'status-cancelled';
                statusText = '‚ùå ƒê√£ h·ªßy';
                disableInvoice = 'disabled';
                disableCancel = 'disabled';
                break;
            }

            const bookingCard = `
                        <div class="col">
                            <div class="booking-card p-3">
                                <h5 class="fw-bold">M√£: #${item.id}</h5>
                                <p><strong>T√™n s√¢n:</strong> ${item.field}</p>
                                <p><strong>ƒê·ªãa ch·ªâ:</strong> ${item.address}</p>
                                <p><strong>Ng√†y:</strong> ${item.date}</p>
                                <p><strong>Gi·ªù b·∫Øt ƒë·∫ßu:</strong> ${item.start_time}</p>
                                <p><strong>Gi·ªù k·∫øt th√∫c:</strong> ${item.end_time}</p>
                                <p class="${statusClass}">${statusText}</p>
                                <button class="btn btn-primary btn-sm" ${disableInvoice}
                                onclick=seeDetailBill(${item.id})
                                >Xem h√≥a ƒë∆°n</button>
                                <button class="btn btn-danger btn-sm" ${disableCancel}
                                onclick=cancelBooking(${item.id})
                                >H·ªßy</button>
                            </div>
                        </div>
                    `;
            scheduleList.append(bookingCard);
          });
        }
      },
      error: function (error) {
        console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
      }
    });
  }

  function seeDetailBill(id) {
    localStorage.setItem("bookingId", id)
    window.location.href = '/user/booking-bill'
  }
  function cancelBooking(id) {
    Swal.fire({
      title: "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë·∫∑t c√≥ m√£ l√† " + id + " kh√¥ng ?",
      // text: "H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "C√≥",
      cancelButtonText: "Kh√¥ng"
    }).then((result) => {
      if (result.isConfirmed) {

        $.ajax({
          url: "/api/booking/cancel-booking-for-user",
          type: "POST",
          data: { bookingId: id },
          success: function (response) {
            // alert(response.message); // Hi·ªÉn th·ªã th√¥ng b√°o t·ª´ server
            Swal.fire("ƒê√£ h·ªßy l·ªãch ƒë·∫∑t!", response.message, "success").then(() => {
              location.reload(); // Reload trang sau khi ng∆∞·ªùi d√πng nh·∫•n OK
            });
          },
          error: function (xhr) {
            // alert("C√≥ l·ªói x·∫£y ra: " + xhr.responseText);
            Swal.fire("ƒê√£ h·ªßy l·ªãch ƒë·∫∑t!", xhr.responseText, "error");
          }
        });
      }
    });
  }

</script>

</html>